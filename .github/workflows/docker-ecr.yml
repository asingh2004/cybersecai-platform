name: Build, Push, and Deploy All Microservices to ECS

on:
  push:
    branches: [main, master, staging]
  workflow_dispatch:

concurrency:
  group: ecs-${{ github.ref_name }}
  cancel-in-progress: false

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  CLUSTER_NAME: mochanai-staging-ecs-cluster

jobs:
  build_push_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set common env
        id: set-env
        run: |
          echo "ECR=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_OUTPUT
          echo "SHA=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      # Build and push all images with immutable SHA tag (also push :latest for human convenience)
      - name: Build and push images - Laravel (php/nginx)
        run: |
          ECR=${{ steps.set-env.outputs.ECR }}
          SHA=${{ steps.set-env.outputs.SHA }}

          docker build --target php   -t $ECR/mochanai-staging-laravel-php:$SHA   -t $ECR/mochanai-staging-laravel-php:latest   -f Dockerfile.app .
          docker build --target nginx -t $ECR/mochanai-staging-laravel-nginx:$SHA -t $ECR/mochanai-staging-laravel-nginx:latest -f Dockerfile.app .

          docker push $ECR/mochanai-staging-laravel-php:$SHA
          docker push $ECR/mochanai-staging-laravel-php:latest
          docker push $ECR/mochanai-staging-laravel-nginx:$SHA
          docker push $ECR/mochanai-staging-laravel-nginx:latest

      - name: Build and push image - Webhook Server
        run: |
          ECR=${{ steps.set-env.outputs.ECR }}
          SHA=${{ steps.set-env.outputs.SHA }}
          docker build -t $ECR/mochanai-staging-webhook-server:$SHA -t $ECR/mochanai-staging-webhook-server:latest -f ./fastapi-services/webhook/Dockerfile.fastapi ./fastapi-services/webhook
          docker push $ECR/mochanai-staging-webhook-server:$SHA
          docker push $ECR/mochanai-staging-webhook-server:latest

      - name: Build and push images - Agentic (prod, orchestrator, service)
        run: |
          ECR=${{ steps.set-env.outputs.ECR }}
          SHA=${{ steps.set-env.outputs.SHA }}
          # All three currently build from same Dockerfile path you provided
          docker build -t $ECR/mochanai-staging-prod-agentic-orchestrator-service:$SHA -t $ECR/mochanai-staging-prod-agentic-orchestrator-service:latest -f ./fastapi-services/agenticai/Dockerfile.fastapi ./fastapi-services/agenticai
          docker build -t $ECR/mochanai-staging-agentic-orchestrator-service:$SHA  -t $ECR/mochanai-staging-agentic-orchestrator-service:latest  -f ./fastapi-services/agenticai/Dockerfile.fastapi ./fastapi-services/agenticai
          docker build -t $ECR/mochanai-staging-agentic-service:$SHA              -t $ECR/mochanai-staging-agentic-service:latest              -f ./fastapi-services/agenticai/Dockerfile.fastapi ./fastapi-services/agenticai

          docker push $ECR/mochanai-staging-prod-agentic-orchestrator-service:$SHA
          docker push $ECR/mochanai-staging-prod-agentic-orchestrator-service:latest
          docker push $ECR/mochanai-staging-agentic-orchestrator-service:$SHA
          docker push $ECR/mochanai-staging-agentic-orchestrator-service:latest
          docker push $ECR/mochanai-staging-agentic-service:$SHA
          docker push $ECR/mochanai-staging-agentic-service:latest

      - name: Build and push images - Databreach (event advisor + steps)
        run: |
          ECR=${{ steps.set-env.outputs.ECR }}
          SHA=${{ steps.set-env.outputs.SHA }}

          docker build -t $ECR/mochanai-staging-databreach-event-advisor:$SHA -t $ECR/mochanai-staging-databreach-event-advisor:latest -f ./fastapi-services/databreachmgmt/Dockerfile.fastapi ./fastapi-services/databreachmgmt
          docker build -t $ECR/mochanai-staging-databreach-step1:$SHA         -t $ECR/mochanai-staging-databreach-step1:latest         -f ./fastapi-services/databreachmgmt/Dockerfile.fastapi ./fastapi-services/databreachmgmt
          docker build -t $ECR/mochanai-staging-databreach-step2:$SHA         -t $ECR/mochanai-staging-databreach-step2:latest         -f ./fastapi-services/databreachmgmt/Dockerfile.fastapi ./fastapi-services/databreachmgmt
          docker build -t $ECR/mochanai-staging-databreach-step3:$SHA         -t $ECR/mochanai-staging-databreach-step3:latest         -f ./fastapi-services/databreachmgmt/Dockerfile.fastapi ./fastapi-services/databreachmgmt

          docker push $ECR/mochanai-staging-databreach-event-advisor:$SHA
          docker push $ECR/mochanai-staging-databreach-event-advisor:latest
          docker push $ECR/mochanai-staging-databreach-step1:$SHA
          docker push $ECR/mochanai-staging-databreach-step1:latest
          docker push $ECR/mochanai-staging-databreach-step2:$SHA
          docker push $ECR/mochanai-staging-databreach-step2:latest
          docker push $ECR/mochanai-staging-databreach-step3:$SHA
          docker push $ECR/mochanai-staging-databreach-step3:latest

      - name: Build and push image - PROD DB Privacy Discovery
        run: |
          ECR=${{ steps.set-env.outputs.ECR }}
          SHA=${{ steps.set-env.outputs.SHA }}
          docker build -t $ECR/mochanai-staging-prod-db-privacy-discovery-service:$SHA -t $ECR/mochanai-staging-prod-db-privacy-discovery-service:latest -f ./fastapi-services/Databases/Dockerfile.fastapi ./fastapi-services/Databases
          docker push $ECR/mochanai-staging-prod-db-privacy-discovery-service:$SHA
          docker push $ECR/mochanai-staging-prod-db-privacy-discovery-service:latest

      # Download base task definitions once
      - name: Download TaskDefs
        run: |
          aws ecs describe-task-definition --task-definition mochanai-staging-laravel-app                         --query 'taskDefinition' > base-td-laravel-app.json
          aws ecs describe-task-definition --task-definition mochanai-staging-agentic-app                         --query 'taskDefinition' > base-td-agentic-app.json
          aws ecs describe-task-definition --task-definition mochanai-staging-databreach-app                      --query 'taskDefinition' > base-td-databreach-app.json
          aws ecs describe-task-definition --task-definition mochanai-staging-prod-db-privacy-discovery-service   --query 'taskDefinition' > base-td-privacy-discovery.json

      # Render and deploy Laravel (update all containers, deploy once)
      - name: Render TD Laravel - php
        id: td-laravel-php
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: base-td-laravel-app.json
          container-name: laravel-php
          image: ${{ steps.set-env.outputs.ECR }}/mochanai-staging-laravel-php:${{ steps.set-env.outputs.SHA }}

      - name: Render TD Laravel - nginx
        id: td-laravel-nginx
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ steps.td-laravel-php.outputs.task-definition }}
          container-name: laravel-nginx
          image: ${{ steps.set-env.outputs.ECR }}/mochanai-staging-laravel-nginx:${{ steps.set-env.outputs.SHA }}

      - name: Render TD Laravel - webhook
        id: td-laravel-webhook
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ steps.td-laravel-nginx.outputs.task-definition }}
          container-name: webhook_server
          image: ${{ steps.set-env.outputs.ECR }}/mochanai-staging-webhook-server:${{ steps.set-env.outputs.SHA }}

      - name: Deploy Laravel app
        id: deploy-laravel
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.td-laravel-webhook.outputs.task-definition }}
          service: mochanai-staging-laravel-app
          cluster: ${{ env.CLUSTER_NAME }}
          wait-for-service-stability: true

      # Render and deploy Agentic app (all containers, one deploy)
      - name: Render TD Agentic - prod orchestrator
        id: td-agentic-prod-orch
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: base-td-agentic-app.json
          container-name: prod_agentic_orchestrator_service
          image: ${{ steps.set-env.outputs.ECR }}/mochanai-staging-prod-agentic-orchestrator-service:${{ steps.set-env.outputs.SHA }}

      - name: Render TD Agentic - orchestrator
        id: td-agentic-orch
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ steps.td-agentic-prod-orch.outputs.task-definition }}
          container-name: agentic_orchestrator_service
          image: ${{ steps.set-env.outputs.ECR }}/mochanai-staging-agentic-orchestrator-service:${{ steps.set-env.outputs.SHA }}

      - name: Render TD Agentic - service
        id: td-agentic-service
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ steps.td-agentic-orch.outputs.task-definition }}
          container-name: agentic_service
          image: ${{ steps.set-env.outputs.ECR }}/mochanai-staging-agentic-service:${{ steps.set-env.outputs.SHA }}

      - name: Deploy Agentic app
        id: deploy-agentic
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.td-agentic-service.outputs.task-definition }}
          service: mochanai-staging-agentic-app
          cluster: ${{ env.CLUSTER_NAME }}
          wait-for-service-stability: true

      # Render and deploy Databreach app (all containers, one deploy)
      - name: Render TD Databreach - event advisor
        id: td-db-event
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: base-td-databreach-app.json
          container-name: databreach_event_advisor
          image: ${{ steps.set-env.outputs.ECR }}/mochanai-staging-databreach-event-advisor:${{ steps.set-env.outputs.SHA }}

      - name: Render TD Databreach - step1
        id: td-db-step1
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ steps.td-db-event.outputs.task-definition }}
          container-name: databreach_step1
          image: ${{ steps.set-env.outputs.ECR }}/mochanai-staging-databreach-step1:${{ steps.set-env.outputs.SHA }}

      - name: Render TD Databreach - step2
        id: td-db-step2
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ steps.td-db-step1.outputs.task-definition }}
          container-name: databreach_step2
          image: ${{ steps.set-env.outputs.ECR }}/mochanai-staging-databreach-step2:${{ steps.set-env.outputs.SHA }}

      - name: Render TD Databreach - step3
        id: td-db-step3
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ steps.td-db-step2.outputs.task-definition }}
          container-name: databreach_step3
          image: ${{ steps.set-env.outputs.ECR }}/mochanai-staging-databreach-step3:${{ steps.set-env.outputs.SHA }}

      - name: Deploy Databreach app
        id: deploy-databreach
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.td-db-step3.outputs.task-definition }}
          service: mochanai-staging-databreach-app
          cluster: ${{ env.CLUSTER_NAME }}
          wait-for-service-stability: true

      # Render and deploy Privacy Discovery
      - name: Render TD Privacy Discovery
        id: td-privacy
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: base-td-privacy-discovery.json
          container-name: prod_db_privacy_discovery_service
          image: ${{ steps.set-env.outputs.ECR }}/mochanai-staging-prod-db-privacy-discovery-service:${{ steps.set-env.outputs.SHA }}

      - name: Deploy Privacy Discovery service
        id: deploy-privacy
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.td-privacy.outputs.task-definition }}
          service: mochanai-staging-prod-db-privacy-discovery-service
          cluster: ${{ env.CLUSTER_NAME }}
          wait-for-service-stability: true

      # Diagnostics on failure
      - name: Dump ECS service events on failure
        if: failure()
        run: |
          set +e
          CLUSTER=${{ env.CLUSTER_NAME }}
          for SVC in mochanai-staging-laravel-app mochanai-staging-agentic-app mochanai-staging-databreach-app mochanai-staging-prod-db-privacy-discovery-service; do
            echo "===== Service: $SVC ====="
            aws ecs describe-services --cluster "$CLUSTER" --services "$SVC" --query 'services[0].events[0:20]'
            TASKS=$(aws ecs list-tasks --cluster "$CLUSTER" --service-name "$SVC" --desired-status STOPPED --query 'taskArns' --output text)
            if [ -n "$TASKS" ]; then
              aws ecs describe-tasks --cluster "$CLUSTER" --tasks $TASKS --query 'tasks[].{taskArn:taskArn,stopCode:stopCode,stoppedReason:stoppedReason,containers:containers[].reason}'
            fi
          done